#!/usr/bin/env python3
"""
Example EST authorization script.

This script is called by the EST server to authorize requests.
It receives a JSON object on stdin with the following structure:

{
  "authzData": {
    "principal": {
      "name": "alice",
      "roles": ["estclient", "admin"]
    }
  },
  "operation": "simpleenroll",
  "remoteAddr": "192.168.1.100"
}

Exit with 0 for success, non-zero for failure.
"""

import json
import sys

ALLOWED_ROLE = 'estclient'

try:
    # Read JSON from stdin
    obj = json.loads(sys.stdin.read())

    # Check if principal has required role
    principal_roles = obj.get('authzData', {}).get('principal', {}).get('roles', [])

    if ALLOWED_ROLE not in principal_roles:
        print(f'Principal does not have required role {ALLOWED_ROLE!r}', file=sys.stderr)
        sys.exit(1)

    # Authorization successful
    sys.exit(0)

except Exception as e:
    print(f'Authorization error: {e}', file=sys.stderr)
    sys.exit(1)
